name: Build Windows App

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'  # 推送 v 开头的 tag 时触发（如 v1.0.0）
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # 允许手动触发
    inputs:
      create_release:
        description: '是否创建 GitHub Release'
        required: false
        type: boolean
        default: false

# 明确声明需要的权限
permissions:
  contents: write  # 创建 Release 和上传资源

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 提取版本号
      id: version
      shell: pwsh
      run: |
        # 检查是否是 tag 触发
        $gitRef = "${{ github.ref }}"

        if ($gitRef -match '^refs/tags/v(.+)$') {
            # Tag 触发：使用 tag 版本号（去掉 v 前缀）
            $version = $matches[1]
            Write-Host "✓ 使用 Git Tag 版本号: $version"
        } else {
            # 非 Tag 触发：从 pubspec.yaml 读取
            $content = Get-Content pubspec.yaml -Raw
            $version = [regex]::Match($content, 'version:\s+([^\s#]+)').Groups[1].Value
            Write-Host "✓ 使用 pubspec.yaml 版本号: $version"
        }

        # 验证版本号格式
        if ($version -notmatch '^\d+\.\d+\.\d+(\+\d+)?$') {
            Write-Error "版本号格式不正确: $version"
            exit 1
        }

        # 去掉构建号，用于文件名和Release标题（0.0.2 而不是 0.0.2+1）
        $releaseVersion = $version -replace '\+.*$', ''

        echo "APP_VERSION=$version" >> $env:GITHUB_ENV
        echo "RELEASE_VERSION=$releaseVersion" >> $env:GITHUB_ENV
        echo "version=$releaseVersion" >> $env:GITHUB_OUTPUT
        Write-Host "✓ 发布版本号: $releaseVersion"

    - name: 设置 Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        flutter-version: '3.32.5'  # 锁定到已知可工作的版本 (Dart 3.8.1)
        cache: true  # 启用 Flutter SDK 缓存

    - name: 缓存 Pub 依赖
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.LOCALAPPDATA }}\Pub\Cache
          **/.dart_tool
        key: ${{ runner.os }}-flutter-3.32.5-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-3.32.5-pub-

    - name: 启用 Windows 桌面支持
      run: flutter config --enable-windows-desktop

    - name: 检查 Flutter 环境
      run: flutter doctor -v

    - name: 获取依赖
      run: flutter pub get

    - name: 清理构建产物
      run: flutter clean

    - name: 编译 Windows Release 版本
      run: flutter build windows --release --verbose

    - name: 创建发布目录结构
      shell: pwsh
      run: |
        $sourcePath = "build/windows/x64/runner/Release"
        if (-not (Test-Path $sourcePath)) {
            Write-Error "编译产物路径不存在: $sourcePath"
            exit 1
        }

        $releaseDir = "wms_station_kanban_v${{ env.RELEASE_VERSION }}_windows_x64"
        New-Item -ItemType Directory -Force -Path $releaseDir
        Copy-Item -Path "$sourcePath/*" -Destination $releaseDir -Recurse
        echo "RELEASE_DIR=$releaseDir" >> $env:GITHUB_ENV

    - name: 打包编译产物
      shell: pwsh
      run: |
        $zipName = "wms_station_kanban_v${{ env.RELEASE_VERSION }}_windows_x64.zip"
        Compress-Archive -Path "${{ env.RELEASE_DIR }}/*" -DestinationPath $zipName
        echo "ZIP_NAME=$zipName" >> $env:GITHUB_ENV
        echo "打包完成: $zipName"
        echo "文件大小: $((Get-Item $zipName).Length / 1MB) MB"

    - name: 上传编译产物
      uses: actions/upload-artifact@v4
      with:
        name: wms_station_kanban_v${{ env.RELEASE_VERSION }}_windows_x64
        path: ${{ env.ZIP_NAME }}
        retention-days: 30

    # 只在推送 tag 时创建 Release
    - name: 创建 GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ env.ZIP_NAME }}
        tag_name: ${{ github.ref_name }}
        name: WMS Station Kanban ${{ env.RELEASE_VERSION }}
        body: |
          ## 下载
          - **Windows x64**: ${{ env.ZIP_NAME }}

          ## 版本信息
          - 版本: ${{ env.RELEASE_VERSION }}
          - 构建时间: ${{ github.event.head_commit.timestamp || 'N/A' }}
          - 提交: ${{ github.sha }}
        draft: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
